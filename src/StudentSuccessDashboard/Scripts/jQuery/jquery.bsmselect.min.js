(function(n){function t(t,i){this.$original=n(t),this.buildingSelect=!1,this.ieClick=!1,this.ignoreOriginalChangeEvent=!1,this.options=i,this.buildDom()}t.prototype={generateUid:function(n){return this.uid=this.options.containerClass+n},buildDom:function(){var r=this,t=this.options,i;for(t.addItemTarget==="original"&&n("option",this.$original).each(function(t,i){n(i).data("bsm-order")===null&&n(i).data("bsm-order",t)}),i=0;n("#"+this.generateUid(i)).size();i++);this.$select=n("<select>",{"class":t.selectClass,name:t.selectClass+this.uid,id:t.selectClass+this.uid,change:n.proxy(this.selectChangeEvent,this),click:n.proxy(this.selectClickEvent,this)}),this.$list=n.isFunction(t.listType)?t.listType(this.$original):n("<"+t.listType+">",{id:t.listClass+this.uid}),this.$list.addClass(t.listClass),this.$container=n("<div>",{"class":t.containerClass,id:this.uid}),this.buildSelect(),this.$original.change(n.proxy(this.originalChangeEvent,this)).wrap(this.$container).before(this.$select),this.$list.parent().length||this.$original.before(this.$list),this.$original.attr("id")&&n("label[for="+this.$original.attr("id")+"]").attr("for",this.$select.attr("id")),this.$list.delegate("."+t.removeClass,"click",function(){return r.dropListItem(n(this).closest("li")),!1}),n.each(t.plugins,function(){this.init(r)})},selectChangeEvent:function(){if(!n.browser.msie||!(n.browser.version<7)||this.ieClick){var t=n("option:selected:eq(0)",this.$select);t.data("orig-option")&&(this.addListItem(t),this.triggerOriginalChange(t.data("orig-option"),"add")),this.ieClick=!1}},selectClickEvent:function(){this.ieClick=!0},originalChangeEvent:function(){this.ignoreOriginalChangeEvent?this.ignoreOriginalChangeEvent=!1:(this.buildSelect(),n.browser.opera&&this.$list.hide().show())},buildSelect:function(){var t=this;this.buildingSelect=!0,this.$select.empty().prepend(n('<option value=""><\/option>').text(this.$original.attr("title")||this.options.title)),this.$list.empty(),this.$original.children().each(function(){n(this).is("option")?t.addSelectOption(t.$select,n(this)):n(this).is("optgroup")&&t.addSelectOptionGroup(t.$select,n(this))}),this.options.debugMode||this.$original.hide(),this.selectFirstItem(),this.buildingSelect=!1},addSelectOption:function(t,i){var r=n("<option>",{text:i.text(),val:i.val()}).appendTo(t).data("orig-option",i),u=i.is(":selected"),f=i.is(":disabled");i.data("bsm-option",r),u&&!f?(this.addListItem(r),this.disableSelectOption(r)):!u&&f&&this.disableSelectOption(r)},addSelectOptionGroup:function(t,i){var u=this,r=n("<optgroup>",{label:i.attr("label")}).appendTo(t);i.is(":disabled")&&r.attr("disabled","disabled"),n("option",i).each(function(){u.addSelectOption(r,n(this))})},selectFirstItem:function(){n("option:eq(0)",this.$select).attr("selected","selected")},disableSelectOption:function(t){t.addClass(this.options.optionDisabledClass).removeAttr("selected").attr("disabled","disabled").toggle(!this.options.hideWhenAdded),n.browser.msie&&n.browser.version<8&&this.$select.hide().show()},enableSelectOption:function(t){t.removeClass(this.options.optionDisabledClass).removeAttr("disabled").toggle(!this.options.hideWhenAdded),n.browser.msie&&n.browser.version<8&&this.$select.hide().show()},addListItem:function(t){var r,u=t.data("orig-option"),i=this.options,e,f;if(u){if(!this.buildingSelect){if(u.is(":selected"))return;u.attr("selected","selected")}r=n("<li>",{"class":i.listItemClass}).append(n("<span>",{"class":i.listItemLabelClass,html:i.extractLabel(t,i)})).append(n("<a>",{href:"#","class":i.removeClass,html:i.removeLabel})).data("bsm-option",t),this.disableSelectOption(t.data("item",r));switch(i.addItemTarget){case"bottom":this.$list.append(r.hide());break;case"original":e=u.data("bsm-order"),f=!1,n("."+i.listItemClass,this.$list).each(function(){if(e<n(this).data("bsm-option").data("orig-option").data("bsm-order"))return r.hide().insertBefore(this),f=!0,!1}),f||this.$list.append(r.hide());break;default:this.$list.prepend(r.hide())}this.buildingSelect?n.bsmSelect.effects.show(r):(i.showEffect(r),i.highlightEffect(this.$select,r,i.highlightAddedLabel,this.options),this.selectFirstItem())}},dropListItem:function(t){var r=t.data("bsm-option"),i=this.options;r.removeData("item").data("orig-option").removeAttr("selected"),(this.buildingSelect?n.bsmSelect.effects.remove:i.hideEffect)(t),this.enableSelectOption(r),i.highlightEffect(this.$select,t,i.highlightRemovedLabel,i),this.triggerOriginalChange(r.data("orig-option"),"drop")},triggerOriginalChange:function(n,t){this.ignoreOriginalChangeEvent=!0,this.$original.trigger("change",[{option:n,value:n.val(),item:n.data("bsm-option").data("item"),type:t}])}},n.fn.bsmSelect=function(i){var r=n.extend({},n.bsmSelect.conf,i);return this.each(function(){var i=n(this).data("bsmSelect");i||(i=new t(n(this),r),n(this).data("bsmSelect",i))})},n.bsmSelect={},n.extend(n.bsmSelect,{effects:{show:function(n){n.show()},remove:function(n){n.remove()},highlight:function(t,i,r,u){var f,e=t.attr("id")+u.highlightClass;n("#"+e).remove(),f=n("<span>",{"class":u.highlightClass,id:e,html:r+i.children("."+u.listItemLabelClass).first().text()}).hide(),t.after(f.fadeIn("fast").delay(50).fadeOut("slow",function(){n(this).remove()}))},verticalListAdd:function(t){t.animate({opacity:"show",height:"show"},100,function(){n(this).animate({height:"+=2px"},100,function(){n(this).animate({height:"-=2px"},100)})})},verticalListRemove:function(t){t.animate({opacity:"hide",height:"hide"},100,function(){n(this).prev("li").animate({height:"-=2px"},100,function(){n(this).animate({height:"+=2px"},100)}),n(this).remove()})}},plugins:{}}),n.bsmSelect.conf={listType:"ol",showEffect:n.bsmSelect.effects.show,hideEffect:n.bsmSelect.effects.remove,highlightEffect:n.noop,addItemTarget:"bottom",hideWhenAdded:!1,debugMode:!1,title:"Select...",removeLabel:"remove",highlightAddedLabel:"Added: ",highlightRemovedLabel:"Removed: ",extractLabel:function(n){return n.html()},plugins:[],containerClass:"bsmContainer",selectClass:"bsmSelect",optionDisabledClass:"bsmOptionDisabled",listClass:"bsmList",listItemClass:"bsmListItem",listItemLabelClass:"bsmListItemLabel",removeClass:"bsmListItemRemove",highlightClass:"bsmHighlight"}})(jQuery);